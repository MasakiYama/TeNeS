import subprocess
import sys
from shutil import rmtree, move
from os.path import exists, join

import numpy as np


def check(filename, resdir, refdir, *, rtol, atol):
    res = []
    with open(join(resdir, filename)) as f:
        for line in f:
            line = line.split("#")[0].strip()
            if not line:
                continue
            words = line.split()
            res.append(list(map(float, words)))

    ref = []
    with open(join(refdir, filename)) as f:
        for line in f:
            line = line.split("#")[0].strip()
            if not line:
                continue
            words = line.split()
            ref.append(list(map(float, words)))

    if len(res) != len(ref):
        print("{}: number of entries do not match".format(filename))
        print("  result:    {}".format(len(res)))
        print("  reference: {}".format(len(ref)))
        return False

    fl = True
    for i, (rs, rf) in enumerate(zip(res, ref)):
        for s, f in zip(rs, rf):
            if not np.isclose(s, f, rtol=rtol, atol=atol):
                print("{}: {}-th data do not match:".format(filename, i))
                print("  result:    ", " ".join(map(str, rs)))
                print("  reference: ", " ".join(map(str, rf)))
                fl = False
    return fl

testname = sys.argv[1]
cmd = [join("@CMAKE_BINARY_DIR@", "src", "tenes"), join("data", "{}.toml".format(testname))]
subprocess.call(cmd)
resdir = "output_{}".format(testname)
if exists(resdir):
    rmtree(resdir)
move("output", resdir)
refdir = join("data", resdir)
atol = 1.0e-4
rtol = 1.0e-3

result = True

result = check("onesite_obs.dat", resdir, refdir, rtol=rtol, atol=atol) and result
result = check("twosite_obs.dat", resdir, refdir, rtol=rtol, atol=atol) and result
# result = check("correlation.dat", resdir, refdir, tol) and result

if result:
    sys.exit(0)
else:
    sys.exit(1)
